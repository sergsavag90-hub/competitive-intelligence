services:
  fastapi:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: ci-fastapi
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql+asyncpg://user:password@postgres:5432/competitive_intelligence}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - FRONTEND_ORIGINS=${FRONTEND_ORIGINS}
    ports:
      - "8100:8100"
    volumes:
      - ./logs:/app/logs
    networks:
      - selenium-grid
    depends_on:
      - selenium-hub
      - redis
      - postgres
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    command: uvicorn backend.fastapi_app:app --host 0.0.0.0 --port 8100

  rabbitmq:
    image: rabbitmq:3-management
    container_name: ci-rabbitmq
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped
    networks:
      - selenium-grid

  celery-worker:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: ci-celery-worker
    command: celery -A src.celery_app worker -Q high-priority,low-priority -l info --concurrency=2
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
    environment:
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DATABASE_URL=${DATABASE_URL:-postgresql+asyncpg://user:password@postgres:5432/competitive_intelligence}
    depends_on:
      - rabbitmq
      - redis
      - postgres
    networks:
      - selenium-grid

  celery-beat:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: ci-celery-beat
    command: celery -A src.celery_app beat -l info
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
    environment:
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      - rabbitmq
      - redis
    networks:
      - selenium-grid

  frontend:
    build:
      context: ./frontend
    container_name: ci-frontend
    restart: unless-stopped
    environment:
      - VITE_API_URL=http://localhost:8100
    ports:
      - "3000:80"
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 256M
    depends_on:
      fastapi:
        condition: service_healthy
    networks:
      - selenium-grid

  redis:
    image: redis:7-alpine
    container_name: ci-redis
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - selenium-grid

  # Ollama для LLM аналізу (опціонально)
  # Ollama service disabled for minimum hardware requirements
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: ollama-intelligence
  #   restart: unless-stopped
  #   ports:
  #     - "11434:11434"
  #   volumes:
  #     - ollama-data:/root/.ollama
  #   networks:
  #     - selenium-grid
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: all
  #             capabilities: [gpu]

  # Cron для автоматичного сканування
  intelligence-cron:
    build:
      context: .
      dockerfile: Dockerfile
    profiles:
      - cron
    container_name: competitive-intelligence-cron
    restart: unless-stopped
    environment:
      - SELENIUM_HUB_URL=${SELENIUM_HUB_URL:-http://selenium-hub:4444/wd/hub}
      - DATABASE_PATH=${DATABASE_PATH:-/data/competitive_intelligence.db}
    volumes:
      - ./data:/data
      - ./exports:/app/exports
      - ./logs:/app/logs
    networks:
      - selenium-grid
    depends_on:
      - selenium-hub
    command: >
      sh -c "
      echo '0 3 * * * root cd /app && python run_intelligence.py --full --silent' > /etc/cron.d/intelligence &&
      chmod 0644 /etc/cron.d/intelligence &&
      crontab /etc/cron.d/intelligence &&
      cron -f
      "

volumes:
  ollama-data:
  redis-data:

networks:
  selenium-grid:
    name: selenium-grid
    driver: bridge
