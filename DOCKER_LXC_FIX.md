# üîß –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è Docker AppArmor –≤ LXC

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∑–±—ñ—Ä—Ü—ñ Docker –æ–±—Ä–∞–∑—ñ–≤ –≤ LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ –≤–∏–Ω–∏–∫–∞—î –ø–æ–º–∏–ª–∫–∞:

```
ERROR: process "/bin/sh -c apt-get update..." did not complete successfully
runc run failed: unable to apply apparmor profile: apparmor failed to apply profile
write fsmount:fscontext:proc/thread-self/attr/apparmor/exec: no such file or directory
```

## –ü—Ä–∏—á–∏–Ω–∞

Docker –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ AppArmor –¥–ª—è —ñ–∑–æ–ª—è—Ü—ñ—ó –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤, –∞–ª–µ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ AppArmor –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–Ω –∫–µ—Ä—É—î—Ç—å—Å—è —Ö–æ—Å—Ç-—Å–∏—Å—Ç–µ–º–æ—é Proxmox.

## –†—ñ—à–µ–Ω–Ω—è

–©–æ–± Docker —Å—Ç–∞–±—ñ–ª—å–Ω–æ –ø—Ä–∞—Ü—é–≤–∞–≤ —É LXC, –ø–æ—Ç—Ä—ñ–±–Ω–æ:

1. –£–≤—ñ–º–∫–Ω—É—Ç–∏ `unconfined` AppArmor –¥–ª—è —Å–∞–º–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ Proxmox —Ö–æ—Å—Ç—ñ.
2. –û–Ω–æ–≤–∏—Ç–∏ `daemon.json` –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ LXC (–±–µ–∑ –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤) —ñ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ Docker.

### 1. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –Ω–∞ Proxmox —Ö–æ—Å—Ç—ñ

```bash
# –ù–∞ Proxmox: –∑—É–ø–∏–Ω—ñ—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
pct stop <VMID>

# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –¥–æ–∑–≤–æ–ª–µ–Ω–æ nesting/keyctl
pct set <VMID> --features keyctl=1,nesting=1

# –î–æ–¥–∞–π—Ç–µ AppArmor –ø—Ä–æ—Ñ—ñ–ª—å unconfined —É –∫–æ–Ω—Ñ—ñ–≥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
echo "lxc.apparmor.profile: unconfined" >> /etc/pve/lxc/<VMID>.conf

# –ó–∞–ø—É—Å—Ç—ñ—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–Ω–æ–≤—É
pct start <VMID>
```

> –Ø–∫—â–æ —Ñ–∞–π–ª `/etc/pve/lxc/<VMID>.conf` –≤–∂–µ –º—ñ—Å—Ç–∏—Ç—å –ø–æ—Ç—Ä—ñ–±–Ω–∏–π —Ä—è–¥–æ–∫, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å,
> —â–æ –≤—ñ–Ω –Ω–µ –∑–∞–∫–æ–º–µ–Ω—Ç–æ–≤–∞–Ω–∏–π.

### 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è Docker –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ LXC

```bash
cd /opt/competitive-intelligence
./fix-docker-apparmor.sh
```

–°–∫—Ä–∏–ø—Ç:
- ‚úÖ —Å—Ç–≤–æ—Ä–∏—Ç—å backup `daemon.json`;
- ‚úÖ –∑–∞–ø–∏—à–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é (overlay2, json-file –∑ —Ä–æ—Ç–∞—Ü—ñ—î—é, ulimits);
- ‚úÖ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Docker —Ç–∞ –≤–∏–∫–æ–Ω–∞—î smoke-—Ç–µ—Å—Ç–∏.

### –†—É—á–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

–Ø–∫—â–æ –Ω–µ —Ö–æ—á–µ—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç–∏ —Å–∫—Ä–∏–ø—Ç:

1. –í–∏–∫–æ–Ω–∞–π—Ç–µ –∫—Ä–æ–∫–∏ –Ω–∞ Proxmox —Ö–æ—Å—Ç—ñ (–¥–∏–≤. –≤–∏—â–µ).
2. –í—Å–µ—Ä–µ–¥–∏–Ω—ñ LXC –≤—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ `daemon.json`:

```bash
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json > /dev/null <<'EOF'
{
  "storage-driver": "overlay2",
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "default-ulimits": {
    "nofile": {
      "Name": "nofile",
      "Hard": 64000,
      "Soft": 64000
    }
  }
}
EOF

sudo systemctl restart docker
docker run --rm hello-world
```

## –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞

–ü—ñ—Å–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:

```bash
# 1. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ Docker –±–∞—á–∏—Ç—å AppArmor+seccomp
docker info | grep -A3 "Security Options"
# –û—á—ñ–∫—É–≤–∞–Ω–æ: apparmor, seccomp, cgroupns

# 2. –°–ø—Ä–æ–±—É–π—Ç–µ –∑—ñ–±—Ä–∞—Ç–∏ –ø—Ä–æ—Å—Ç–∏–π –æ–±—Ä–∞–∑
cat <<'EOF' | docker build -t test -
FROM alpine:latest
RUN apk add --no-cache bash curl
EOF

# 3. –Ø–∫—â–æ –∑–±—ñ—Ä–∫–∞ –ø—Ä–æ–π—à–ª–∞ —É—Å–ø—ñ—à–Ω–æ - –≤—Å–µ –ø—Ä–∞—Ü—é—î!
docker rmi test
```

## –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç—É

–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è AppArmor, –∑–∞–ø—É—Å—Ç—ñ—Ç—å deployment:

```bash
cd /opt/competitive-intelligence
./deploy.sh
```

## –ë–µ–∑–ø–µ–∫–∞

### ‚ö†Ô∏è –í–∞–∂–ª–∏–≤—ñ –º–æ–º–µ–Ω—Ç–∏:

1. **–ó–º—ñ–Ω–∏ –¥—ñ—é—Ç—å –ª–∏—à–µ –≤ LXC** ‚Äî –≤–∏ —Ä–æ–±–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `unconfined`, –∞–ª–µ —Å–∞–º Proxmox —Ö–æ—Å—Ç –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –ø—ñ–¥ AppArmor.
2. **Docker –ø—Ä–æ–¥–æ–≤–∂—É—î –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ AppArmor/ seccomp**, —Ç–æ–º—É –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ `security-opts` –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ.
3. **LXC –≤–∂–µ –Ω–∞–¥–∞—î —ñ–∑–æ–ª—è—Ü—ñ—é** - Proxmox LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ —Å–∞–º—ñ –ø–æ —Å–æ–±—ñ —ñ–∑–æ–ª—å–æ–≤–∞–Ω—ñ –≤—ñ–¥ —Ö–æ—Å—Ç-—Å–∏—Å—Ç–µ–º–∏:
   - Linux namespaces
   - cgroups
   - seccomp
   - capabilities
4. **–ù–µ –≤–∏–º–∏–∫–∞–π—Ç–µ AppArmor –Ω–∞ –≤—Å—ñ–π —Å–∏—Å—Ç–µ–º—ñ** ‚Äî –∑–º—ñ–Ω—é—î–º–æ –ª–∏—à–µ –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∏

–Ø–∫—â–æ –≤–∏ –Ω–µ —Ö–æ—á–µ—Ç–µ –≤–∏–º–∏–∫–∞—Ç–∏ AppArmor:

### –í–∞—Ä—ñ–∞–Ω—Ç 1: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
```bash
# –ù–∞ Proxmox —Ö–æ—Å—Ç—ñ
pct set 100 --unprivileged 0
pct reboot 100
```
‚ö†Ô∏è –ú–µ–Ω—à –±–µ–∑–ø–µ—á–Ω–æ, –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è

### –í–∞—Ä—ñ–∞–Ω—Ç 2: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è AppArmor –ø—Ä–æ—Ñ—ñ–ª—é –Ω–∞ —Ö–æ—Å—Ç—ñ
```bash
# –ù–∞ Proxmox —Ö–æ—Å—Ç—ñ (—Å–∫–ª–∞–¥–Ω—ñ—à–µ)
# –ü–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ custom AppArmor –ø—Ä–æ—Ñ—ñ–ª—å
# –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –¥–ª—è –±—ñ–ª—å—à–æ—Å—Ç—ñ –≤–∏–ø–∞–¥–∫—ñ–≤
```

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

- [Docker –≤ LXC](https://pve.proxmox.com/wiki/Linux_Container#_using_docker_inside_a_container)
- [Docker Security](https://docs.docker.com/engine/security/)
- [AppArmor Documentation](https://gitlab.com/apparmor/apparmor/-/wikis/home)

## –ü—ñ–¥—Ç—Ä–∏–º–∫–∞

–Ø–∫—â–æ –ø—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è:

1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ Docker:
   ```bash
   sudo journalctl -u docker -n 50
   ```

2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ nesting —É–≤—ñ–º–∫–Ω–µ–Ω–æ:
   ```bash
   # –ù–∞ Proxmox —Ö–æ—Å—Ç—ñ
   pct config 100 | grep features
   # –ú–∞—î –±—É—Ç–∏: features: keyctl=1,nesting=1
   ```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
   ```bash
   # –ù–∞ Proxmox —Ö–æ—Å—Ç—ñ
   pct reboot 100
   ```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ

–Ø–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ —Å–∫—Ä–∏–ø—Ç `create-lxc.sh`, AppArmor –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±—É–¥–µ –≤–∏–∫–æ–Ω–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥ —á–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:

```bash
# –ù–∞ Proxmox —Ö–æ—Å—Ç—ñ
cd /path/to/project/proxmox
./create-lxc.sh 100 selenium-grid dhcp
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
1. –°—Ç–≤–æ—Ä–∏—Ç—å LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
2. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker
3. **–ù–∞–ª–∞—à—Ç—É—î AppArmor** ‚úì
4. –ü—ñ–¥–≥–æ—Ç—É—î –ø—Ä–æ–µ–∫—Ç –¥–æ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è
