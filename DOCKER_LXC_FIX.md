# ðŸ”§ Ð’Ð¸Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ Docker AppArmor Ð² LXC

## ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°

ÐŸÑ€Ð¸ Ð·Ð±Ñ–Ñ€Ñ†Ñ– Docker Ð¾Ð±Ñ€Ð°Ð·Ñ–Ð² Ð² LXC ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ– Ð²Ð¸Ð½Ð¸ÐºÐ°Ñ” Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°:

```
ERROR: process "/bin/sh -c apt-get update..." did not complete successfully
runc run failed: unable to apply apparmor profile: apparmor failed to apply profile
write fsmount:fscontext:proc/thread-self/attr/apparmor/exec: no such file or directory
```

## ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°

Docker Ð½Ð°Ð¼Ð°Ð³Ð°Ñ”Ñ‚ÑŒÑÑ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ²Ð°Ñ‚Ð¸ AppArmor Ð´Ð»Ñ Ñ–Ð·Ð¾Ð»ÑÑ†Ñ–Ñ— ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ–Ð², Ð°Ð»Ðµ Ð²ÑÐµÑ€ÐµÐ´Ð¸Ð½Ñ– LXC ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° AppArmor Ð½Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹, Ð¾ÑÐºÑ–Ð»ÑŒÐºÐ¸ Ð²Ñ–Ð½ ÐºÐµÑ€ÑƒÑ”Ñ‚ÑŒÑÑ Ñ…Ð¾ÑÑ‚-ÑÐ¸ÑÑ‚ÐµÐ¼Ð¾ÑŽ Proxmox.

## Ð Ñ–ÑˆÐµÐ½Ð½Ñ

### ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ðµ Ð²Ð¸Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ (Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð¾Ð²Ð°Ð½Ð¾)

```bash
# Ð’ LXC ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ– Ð²Ð¸ÐºÐ¾Ð½Ð°Ð¹Ñ‚Ðµ:
cd /opt/competitive-intelligence
./fix-docker-apparmor.sh
```

Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾:
- âœ… Ð¡Ñ‚Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ backup Ñ–ÑÐ½ÑƒÑŽÑ‡Ð¾Ñ— ÐºÐ¾Ð½Ñ„Ñ–Ð³ÑƒÑ€Ð°Ñ†Ñ–Ñ—
- âœ… ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÑ” Docker Ð· Ð²Ð¸Ð¼ÐºÐ½ÐµÐ½Ð¸Ð¼ AppArmor
- âœ… ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Docker daemon
- âœ… ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚ÑŒ Ñ‰Ð¾ Ð²ÑÐµ Ð¿Ñ€Ð°Ñ†ÑŽÑ”

### Ð ÑƒÑ‡Ð½Ðµ Ð²Ð¸Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ

Ð¯ÐºÑ‰Ð¾ Ð²Ð°Ð¼ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾ Ð·Ñ€Ð¾Ð±Ð¸Ñ‚Ð¸ Ñ†Ðµ Ð²Ñ€ÑƒÑ‡Ð½Ñƒ:

```bash
# 1. Ð¡Ñ‚Ð²Ð¾Ñ€Ñ–Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ñ–Ð³ÑƒÑ€Ð°Ñ†Ñ–ÑŽ Docker daemon
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json > /dev/null <<'EOF'
{
  "storage-driver": "overlay2",
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "security-opts": [
    "apparmor=unconfined"
  ]
}
EOF

# 2. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ Docker
sudo systemctl restart docker

# 3. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ Ñ‰Ð¾ Ð¿Ñ€Ð°Ñ†ÑŽÑ”
docker run --rm hello-world
```

## ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ°

ÐŸÑ–ÑÐ»Ñ Ð·Ð°ÑÑ‚Ð¾ÑÑƒÐ²Ð°Ð½Ð½Ñ Ð²Ð¸Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ, Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ:

```bash
# 1. Docker info Ð¼Ð°Ñ” Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚Ð¸ security options
docker info | grep -i security
# ÐžÑ‡Ñ–ÐºÑƒÐ²Ð°Ð½Ð¾: Security Options: apparmor=unconfined

# 2. Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ñ–Ð±Ñ€Ð°Ñ‚Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¸Ð¹ Ð¾Ð±Ñ€Ð°Ð·
cat <<'EOF' | docker build -t test -
FROM alpine:latest
RUN apk add --no-cache bash curl
EOF

# 3. Ð¯ÐºÑ‰Ð¾ Ð·Ð±Ñ–Ñ€ÐºÐ° Ð¿Ñ€Ð¾Ð¹ÑˆÐ»Ð° ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾ - Ð²ÑÐµ Ð¿Ñ€Ð°Ñ†ÑŽÑ”!
docker rmi test
```

## Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ

ÐŸÑ–ÑÐ»Ñ Ð²Ð¸Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ AppArmor, Ð·Ð°Ð¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ deployment:

```bash
cd /opt/competitive-intelligence
./deploy.sh
```

## Ð‘ÐµÐ·Ð¿ÐµÐºÐ°

### âš ï¸ Ð’Ð°Ð¶Ð»Ð¸Ð²Ñ– Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð¸:

1. **Ð¦Ðµ Ð±ÐµÐ·Ð¿ÐµÑ‡Ð½Ð¾ Ð´Ð»Ñ LXC ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ–Ð²** - Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¸ Ð²ÑÐµ Ñ‰Ðµ Ñ–Ð·Ð¾Ð»ÑŒÐ¾Ð²Ð°Ð½Ñ– Ð·Ð° Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ð¾ÑŽ:
   - Linux namespaces
   - cgroups
   - seccomp
   - capabilities
   - LXC ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ ÑÐ°Ð¼ Ð¿Ð¾ ÑÐ¾Ð±Ñ–

2. **ÐÐ• Ñ€Ð¾Ð±Ñ–Ñ‚ÑŒ Ñ†Ðµ Ð½Ð° Ñ…Ð¾ÑÑ‚-ÑÐ¸ÑÑ‚ÐµÐ¼Ñ–** - ÐÐ° Ð·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð¸Ñ… Linux ÑÐ¸ÑÑ‚ÐµÐ¼Ð°Ñ… AppArmor Ð´Ð¾Ð´Ð°Ñ” Ð´Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ð¸Ð¹ Ñ€Ñ–Ð²ÐµÐ½ÑŒ Ð±ÐµÐ·Ð¿ÐµÐºÐ¸

3. **LXC Ð²Ð¶Ðµ Ð½Ð°Ð´Ð°Ñ” Ñ–Ð·Ð¾Ð»ÑÑ†Ñ–ÑŽ** - Proxmox LXC ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¸ ÑÐ°Ð¼Ñ– Ð¿Ð¾ ÑÐ¾Ð±Ñ– Ñ–Ð·Ð¾Ð»ÑŒÐ¾Ð²Ð°Ð½Ñ– Ð²Ñ–Ð´ Ñ…Ð¾ÑÑ‚-ÑÐ¸ÑÑ‚ÐµÐ¼Ð¸

## ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð¸

Ð¯ÐºÑ‰Ð¾ Ð²Ð¸ Ð½Ðµ Ñ…Ð¾Ñ‡ÐµÑ‚Ðµ Ð²Ð¸Ð¼Ð¸ÐºÐ°Ñ‚Ð¸ AppArmor:

### Ð’Ð°Ñ€Ñ–Ð°Ð½Ñ‚ 1: Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð°Ð½Ð½Ñ Ð¿Ñ€Ð¸Ð²Ñ–Ð»ÐµÐ¹Ð¾Ð²Ð°Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
```bash
# ÐÐ° Proxmox Ñ…Ð¾ÑÑ‚Ñ–
pct set 100 --unprivileged 0
pct reboot 100
```
âš ï¸ ÐœÐµÐ½Ñˆ Ð±ÐµÐ·Ð¿ÐµÑ‡Ð½Ð¾, Ð½Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÑ”Ñ‚ÑŒÑÑ

### Ð’Ð°Ñ€Ñ–Ð°Ð½Ñ‚ 2: ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ AppArmor Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŽ Ð½Ð° Ñ…Ð¾ÑÑ‚Ñ–
```bash
# ÐÐ° Proxmox Ñ…Ð¾ÑÑ‚Ñ– (ÑÐºÐ»Ð°Ð´Ð½Ñ–ÑˆÐµ)
# ÐŸÐ¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾ ÑÑ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ custom AppArmor Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŒ
# ÐÐµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÑ”Ñ‚ÑŒÑÑ Ð´Ð»Ñ Ð±Ñ–Ð»ÑŒÑˆÐ¾ÑÑ‚Ñ– Ð²Ð¸Ð¿Ð°Ð´ÐºÑ–Ð²
```

## Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ñ–Ñ

- [Docker Ð² LXC](https://pve.proxmox.com/wiki/Linux_Container#_using_docker_inside_a_container)
- [Docker Security](https://docs.docker.com/engine/security/)
- [AppArmor Documentation](https://gitlab.com/apparmor/apparmor/-/wikis/home)

## ÐŸÑ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ°

Ð¯ÐºÑ‰Ð¾ Ð¿Ñ–ÑÐ»Ñ Ð²Ð¸Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ð·Ð°Ð»Ð¸ÑˆÐ°Ñ”Ñ‚ÑŒÑÑ:

1. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ Ð»Ð¾Ð³Ð¸ Docker:
   ```bash
   sudo journalctl -u docker -n 50
   ```

2. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ Ñ‰Ð¾ nesting ÑƒÐ²Ñ–Ð¼ÐºÐ½ÐµÐ½Ð¾:
   ```bash
   # ÐÐ° Proxmox Ñ…Ð¾ÑÑ‚Ñ–
   pct config 100 | grep features
   # ÐœÐ°Ñ” Ð±ÑƒÑ‚Ð¸: features: keyctl=1,nesting=1
   ```

3. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€:
   ```bash
   # ÐÐ° Proxmox Ñ…Ð¾ÑÑ‚Ñ–
   pct reboot 100
   ```

## ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ðµ Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð¿Ñ€Ð¸ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ–

Ð¯ÐºÑ‰Ð¾ Ð²Ð¸ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ `create-lxc.sh`, AppArmor Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð±ÑƒÐ´Ðµ Ð²Ð¸ÐºÐ¾Ð½Ð°Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾ Ð¿Ñ–Ð´ Ñ‡Ð°Ñ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°:

```bash
# ÐÐ° Proxmox Ñ…Ð¾ÑÑ‚Ñ–
cd /path/to/project/proxmox
./create-lxc.sh 100 selenium-grid dhcp
```

Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾:
1. Ð¡Ñ‚Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ LXC ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
2. Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Docker
3. **ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÑ” AppArmor** âœ“
4. ÐŸÑ–Ð´Ð³Ð¾Ñ‚ÑƒÑ” Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð´Ð¾ Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ
